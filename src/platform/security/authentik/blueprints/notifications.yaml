# yaml-language-server: $schema=https://goauthentik.io/blueprints/schema.json
---
version: 1
metadata:
  name: Notifications
entries:
  # Transport: Slack
  - id: transport
    model: authentik_events.notificationtransport
    identifiers:
      name: Slack
    attrs:
      mode: webhook_slack
      webhook_url: !Env AUTHENTIK_NOTIFICATIONS_SLACK_WEBHOOK
      send_once: true

  # Rule for Blueprint Events
  - id: rule_blueprints
    model: authentik_events.notificationrule
    identifiers:
      name: slack-notify-blueprints
    attrs:
      transports:
        - !Reference [authentik_events.notificationtransport, [name, "Slack"]]
      severity: info
      event_severity: any
      event_group: blueprint

  # Rule for Authentication Events (specific admin groups)
  - id: rule_auth_admins
    model: authentik_events.notificationrule
    identifiers:
      name: slack-notify-auth-admins
    attrs:
      transports:
        - !Reference [authentik_events.notificationtransport, [name, "Slack"]]
      severity: alert
      event_severity: any
      event_group: authentication
      groups:
        - !Find [authentik_core.group, [name, "Argo CD Admins"]]
        - !Find [authentik_core.group, [name, "ArgoWF Admins"]]
        - !Find [authentik_core.group, [name, "authentik Admins"]]

  # Policy bindings (reuse defaults)
  - model: authentik_policies.policybinding
    identifiers:
      order: 0
      policy: !Find [authentik_policies.policy, [name, "default-match-configuration-error"]]
      target: !Reference [authentik_events.notificationrule, [name, "slack-notify-blueprints"]]

  - model: authentik_policies.policybinding
    identifiers:
      order: 1
      policy: !Find [authentik_policies.policy, [name, "default-match-policy-exception"]]
      target: !Reference [authentik_events.notificationrule, [name, "slack-notify-blueprints"]]

  - model: authentik_policies.policybinding
    identifiers:
      order: 2
      policy: !Find [authentik_policies.policy, [name, "default-match-property-mapping-exception"]]
      target: !Reference [authentik_events.notificationrule, [name, "slack-notify-blueprints"]]

  # Bind same default exception handling to authentication rule
  - model: authentik_policies.policybinding
    identifiers:
      order: 0
      policy: !Find [authentik_policies.policy, [name, "default-match-configuration-error"]]
      target: !Reference [authentik_events.notificationrule, [name, "slack-notify-auth-admins"]]

  - model: authentik_policies.policybinding
    identifiers:
      order: 1
      policy: !Find [authentik_policies.policy, [name, "default-match-policy-exception"]]
      target: !Reference [authentik_events.notificationrule, [name, "slack-notify-auth-admins"]]

  - model: authentik_policies.policybinding
    identifiers:
      order: 2
      policy: !Find [authentik_policies.policy, [name, "default-match-property-mapping-exception"]]
      target: !Reference [authentik_events.notificationrule, [name, "slack-notify-auth-admins"]]
