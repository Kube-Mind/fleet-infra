# yaml-language-server: $schema=https://goauthentik.io/blueprints/schema.json
---
version: 1
metadata:
  name: Notifications
entries:
  - id: transport
    model: authentik_events.notificationtransport
    identifiers:
      name: Slack
    attrs:
      mode: webhook_slack
      webhook_url: !Env AUTHENTIK_NOTIFICATIONS_SLACK_WEBHOOK
      send_once: true

  - id: rule
    model: authentik_events.notificationrule
    identifiers:
      name: slack-notify-exception-configuration-error
    attrs:
      transports:
        - !KeyOf transport
      severity: alert
      group: !Find [authentik_core.group, [name, "authentik Admins"]]

  - model: authentik_policies.policybinding
    identifiers:
      order: 0
      policy:
        !Find [
          authentik_policies.policy,
          [name, "default-match-configuration-error"],
        ]
      target: !KeyOf rule

  - model: authentik_policies.policybinding
    identifiers:
      order: 1
      policy:
        !Find [
          authentik_policies.policy,
          [name, "default-match-policy-exception"],
        ]
      target: !KeyOf rule

  - model: authentik_policies.policybinding
    identifiers:
      order: 2
      policy:
        !Find [
          authentik_policies.policy,
          [name, "default-match-property-mapping-exception"],
        ]
      target: !KeyOf rule

  # --- New Section: Authentication Success Notifications ---

  # Rule: Notify on all successful authentications
  - id: rule_auth_success
    model: authentik_events.notificationrule
    identifiers:
      name: slack-notify-auth-success
    attrs:
      transports:
        - !KeyOf transport
      severity: notice
      event_severity: any
      event_group: authentication
      actions:
        - authentication.succeeded

  # Bind a default "always match" policy so the rule is active
  - model: authentik_policies.policybinding
    identifiers:
      order: 0
      policy: !Find [authentik_policies.policy, [name, "default-match-all"]]
      target: !KeyOf rule_auth_success