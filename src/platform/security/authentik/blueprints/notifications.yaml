# yaml-language-server: $schema=https://goauthentik.io/blueprints/schema.json
---
version: 1
metadata:
  name: Notifications
entries:
  - id: transport
    model: authentik_events.notificationtransport
    identifiers:
      name: Slack
    attrs:
      mode: webhook_slack
      webhook_url: !Env AUTHENTIK_NOTIFICATIONS_SLACK_WEBHOOK
      send_once: true

  - id: rule
    model: authentik_events.notificationrule
    identifiers:
      name: slack-notify-exception-configuration-error
    attrs:
      transports:
        - !KeyOf transport
      severity: alert
      group: !Find [authentik_core.group, [name, "authentik Admins"]]

  - id: blueprint-rule
    model: authentik_events.notificationrule
    identifiers:
      name: slack-notify-blueprint-change
    attrs:
      transports:
        - !KeyOf transport
      severity: info
      group: !Find [authentik_core.group, [name, "authentik Admins"]]
      # Event type filter: blueprint modifications
      event_severity: info
      verb: updated
      model: authentik_blueprints.blueprintinstance

  - model: authentik_policies.policybinding
    identifiers:
      order: 0
      policy:
        !Find [
          authentik_policies.policy,
          [name, "default-match-configuration-error"],
        ]
      target: !KeyOf rule

  - model: authentik_policies.policybinding
    identifiers:
      order: 1
      policy:
        !Find [
          authentik_policies.policy,
          [name, "default-match-policy-exception"],
        ]
      target: !KeyOf rule

  - model: authentik_policies.policybinding
    identifiers:
      order: 2
      policy:
        !Find [
          authentik_policies.policy,
          [name, "default-match-property-mapping-exception"],
        ]
      target: !KeyOf rule
  
  - model: authentik_policies.policybinding
    identifiers:
      order: 3
      policy:
        !Find [authentik_policies.policy, [name, "default-match-all"]]
      target: !KeyOf blueprint-rule
