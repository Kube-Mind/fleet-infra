# immich-middleware.yaml
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: immich
  namespace: immich
spec:
  entryPoints:
    - websecure
  routes:
    - match: Host(`immich.jcan.dev`)
      kind: Rule
      middlewares:
        - name: immich-upload
      services:
        - name: immich-server
          port: 2283
          serversTransport: immich-transport
  tls:
    certResolver: letsencrypt
---
apiVersion: traefik.io/v1alpha1
kind: ServersTransport
metadata:
  name: immich-transport
  namespace: immich
spec:
  disableHTTP2: true
  respondingTimeouts:
        readTimeout: 0
---
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: immich-upload
  namespace: immich
spec:
  buffering:
    maxRequestBodyBytes: 0              # 0 = unlimited (or set > image size)
    memRequestBodyBytes: 2097152       # 10MB in memory, rest in temp file
    maxResponseBodyBytes: 0             # unlimited response size
    memResponseBodyBytes: 2097152
    retryExpression: "IsNetworkError() && Attempts() <= 2" # only retry for network-level issues